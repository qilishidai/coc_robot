from 任务流程.基础任务框架 import 基础任务
from 任务流程.战宠升级.图像算法 import 是否包含指定颜色_HSV


class 完成兵种或法术升级任务(基础任务):
    """完成兵种或法术升级的确认操作"""

    # ==================== 界面坐标常量 ====================
    确认按钮区域 = (514, 465, 654, 517)
    确认按钮点击坐标 = (577, 492)

    # ==================== 检测参数常量 ====================
    资源不足颜色 = (250, 135, 124)
    颜色检测阈值 = {'色差H': 10, '色差S': 10, '色差V': 10, '最少像素数': 150}

    def 执行(self) -> bool:
        # 判断是否够资源升级
        区域图像 = self.上下文.op.获取屏幕图像cv(*self.确认按钮区域)
        是否资源不足 = 是否包含指定颜色_HSV(
            区域图像, self.资源不足颜色,
            **self.颜色检测阈值
        )

        if 是否资源不足:
            self.上下文.置脚本状态("研究升级：资源不足")
            self._关闭升级面板()
            return False

        ocr结果 = self.执行OCR识别(self.确认按钮区域)
        if "确认" not in str(ocr结果):
            self.上下文.置脚本状态("研究升级：未找到确认按钮")
            self._关闭升级面板()
            return False

        self.上下文.点击(*self.确认按钮点击坐标)  # 点击升级
        self._关闭升级面板()
        return True

    def _关闭升级面板(self):
        """关闭升级面板和研究面板"""
        self.上下文.键盘.按字符按压("esc")  # 关闭升级详情
        self.上下文.键盘.按字符按压("esc")  # 关闭研究面板