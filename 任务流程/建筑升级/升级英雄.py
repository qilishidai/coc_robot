from 任务流程.基础任务框架 import 任务上下文
from 任务流程.夜世界.夜世界打鱼.夜世界基础任务类 import 夜世界基础任务

class 英雄不可升级错误(Exception):
    """当英雄不可升级时抛出的异常"""
    def __init__(self, 英雄名称):
        super().__init__(f"英雄[{英雄名称}]不可升级")
        self.英雄名称 = 英雄名称

    def __str__(self):
        return f"英雄[{self.英雄名称}]不可升级"

class 升级英雄任务(夜世界基础任务):
    """自动检测并升级指定英雄"""

    def __init__(self, 上下文: '任务上下文', 要升级的英雄: str):
        super().__init__(上下文)
        self.要升级的英雄 = 要升级的英雄

        # 英雄及其所在区域映射
        self.英雄区域映射 = {
            "野蛮人之王": (54, 362, 174, 405),
            "弓箭女皇": (191, 371, 319, 407),
            "亡灵王子": (336, 373, 461, 406),
            "大守护者": (493, 361, 594, 401),
            "飞盾战神": (629, 375, 741, 404),
        }

        # 升级相似度阈值
        self.相似度阈值 = 0.85

    def 执行(self) -> bool:
        """检查英雄殿堂界面中指定英雄是否可升级，并执行升级"""
        try:
            self.上下文.置脚本状态(f"正在尝试升级{self.要升级的英雄} ")

            可升级, 坐标 = self.是否出现图片(
                "英雄殿堂界面_升级.bmp",
                self.英雄区域映射[self.要升级的英雄],
                self.相似度阈值
            )

            if 可升级:
                self.上下文.置脚本状态(f"{self.要升级的英雄} 可升级")

                # 点击升级
                x, y = 坐标
                self.上下文.点击(x, y, )
                self.上下文.点击(580, 492)
                return True
            else:
                # 抛出不可升级异常
                raise 英雄不可升级错误(self.要升级的英雄)

        except 英雄不可升级错误 as e:
            # 统一处理不可升级情况：关闭页面 + 状态记录
            self.关闭英雄升级页面()
            self.上下文.置脚本状态(str(e))
            return False

        except Exception as e:
            # 其他异常统一处理
            self.异常处理(e)
            return False

    def 关闭英雄升级页面(self):
        """关闭英雄升级界面"""

        self.上下文.键盘.按字符按压("esc")

    def 异常处理(self, 异常: Exception, 是否重启游戏=True):
        """统一异常处理"""
        super().异常处理(异常)
        self.上下文.发送重启请求(
            f"任务[{self.__class__.__name__}] 触发了异常：{异常}"
        )
