import time

from 任务流程.夜世界.夜世界打鱼.夜世界基础任务类 import 夜世界基础任务


class 更新工人状态任务(夜世界基础任务):

    def 执行(self) -> bool:
        """任务入口"""
        return self.识别当前工人状态写入数据库()

    def 识别当前工人状态写入数据库(self) -> bool:
        """识别屏幕的工人状态并写入数据库"""
        try:
            # OCR 区域：工人数 0/6
            识别结果 = self.执行OCR识别((349, 3, 441, 47))

            if not 识别结果:
                raise ValueError("OCR为空")

            原始文本 = 识别结果[0][1]
            清理文本 = (
                原始文本.replace('O', '0')
                .replace('o', '0')
                .replace(' ', '')
            )

            空闲工人, 工人总数 = map(int, 清理文本.split("/"))

            状态字典 = {
                "空闲工人": 空闲工人,
                "工人总数": 工人总数,
                "更新时间": time.time(),
            }

            # 更新数据库
            self.数据库.更新状态(self.机器人标志, "工人状态", 状态字典)

            # 将时间戳转换为可读格式
            可读时间 = time.strftime("%Y-%m-%d %H:%M:%S", time.localtime(状态字典["更新时间"]))

            self.上下文.置脚本状态(f"工人状态已更新: 空闲工人={空闲工人}, 工人总数={工人总数}, 更新时间={可读时间}")
            return True

        except Exception as e:
            self.上下文.置脚本状态(f"识别工人状态失败: {str(e)}，工人状态未更新")
            return False

    def 是否有空闲工人(self) -> bool:
        """检查数据库中的工人状态是否可信，并判断是否有空闲工人"""
        try:
            状态 = (
                self.数据库
                .获取最新完整状态(self.机器人标志)
                .状态数据["工人状态"]
            )
        except Exception as e:
            self.上下文.置脚本状态(f"读取工人状态失败: {e}")
            return False

        空闲工人 = 状态["空闲工人"]
        工人总数 = 状态["工人总数"]
        更新时间 = 状态["更新时间"]

        # 1. 数据是否过期
        if time.time() - 更新时间 > 120:
            self.上下文.置脚本状态("工人状态数据更新已超过2分钟，状态不可信")
            return False

        # 2. 常见无空闲工人情况
        if 空闲工人 == 0:
            self.上下文.置脚本状态(F"无空闲工人：({空闲工人}/{工人总数})")
            return False

        # 3. 异常情况：7工人但显示1空闲（哥布林）
        if 工人总数 == 7 and 空闲工人 == 1:
            self.上下文.置脚本状态("当前为哥布林活动，显示1工人但实际不可用")
            return False

        # 4. 正常可用
        if 0 <= 空闲工人 <= 工人总数 <= 7:
            self.上下文.置脚本状态(f"工人可用：{空闲工人}/{工人总数}")
            return True

        # 5. 兜底异常
        self.上下文.置脚本状态(f"工人状态异常：{状态}")
        return False
