# 04 - 任务开发

## 任务开发模式

### 创建新任务

```python
from 任务流程.基础任务框架 import 基础任务, 任务上下文

class 我的新任务(基础任务):
    def 执行(self) -> bool:
        try:
            上下文 = self.上下文
            上下文.置脚本状态("执行中...")

            # 使用预初始化的检测引擎
            屏幕图像 = 上下文.op.获取屏幕图像cv(0, 0, 800, 600)
            是否匹配, (x, y), _ = self.模板识别.执行匹配(屏幕图像, "按钮.bmp", 0.9)

            if 是否匹配:
                上下文.点击(x, y, 500)

            return True  # 继续下一任务
        except Exception as e:
            self.异常处理(e)
            return False  # 终止流程
```

### 在主流程中调用

**方法1：在机器人线程中调用**

```python
# 线程/自动化机器人.py 的 _任务流程() 方法中
我的新任务(上下文).执行()
```

**方法2：创建独立任务链**

```python
# 任务流程/我的功能/__init__.py
from 任务流程.基础任务框架 import 基础任务, 任务上下文

def 我的任务链(上下文: 任务上下文):
    """我的任务链入口"""
    任务列表 = [
        任务1(上下文),
        任务2(上下文),
        任务3(上下文)
    ]

    for 任务 in 任务列表:
        if not 任务.执行():
            break
```

## 常用API

### 上下文操作

#### 延时
```python
上下文.脚本延时(1000)  # 延时1秒，支持暂停/停止
```

#### 点击
```python
上下文.点击(x, y, 500)  # 点击(x,y)，延时500ms
上下文.点击(x, y, 500, 是否精确点击=True)  # 精确点击，无随机偏移
```

#### 滑动
```python
上下文.滑动屏幕((x1, y1), (x2, y2))  # 贝塞尔曲线滑动
```

#### 日志
```python
上下文.置脚本状态("正在执行某操作...")  # 记录日志
```

#### 重启
```python
上下文.发送重启请求()  # 请求重启机器人
```

#### 异常处理
```python
try:
    # ... 任务逻辑
except Exception as e:
    self.异常处理(e, 是否重启游戏=True, 是否重启机器人=True)
```

### 检测引擎

#### 模板匹配

```python
# 单模板
是否匹配, (x, y), 相似度 = self.模板识别.执行匹配(
    图像,
    "按钮.bmp",
    0.9  # 相似度阈值
)

# 多模板（OR关系）
是否匹配, (x, y), 相似度 = self.模板识别.执行匹配(
    图像,
    "按钮1.bmp|按钮2.bmp|按钮3.bmp",  # 用|分隔
    0.9
)
```

**注意**：
- 模板路径不含 `模板/` 前缀
- 多模板匹配任意一个即返回True

#### OCR识别

```python
结果, _ = self.ocr引擎(图像)

# 结果格式: [[[坐标], 文本], ...]
for 识别结果 in 结果:
    坐标, 文本 = 识别结果
    print(f"识别到文本: {文本}, 位置: {坐标}")
```

#### YOLO检测

```python
检测列表 = self.检测器.检测(图像)

# 结果格式: [{类别名称, 裁剪坐标, 置信度}, ...]
for 检测 in 检测列表:
    类别 = 检测["类别名称"]
    坐标 = 检测["裁剪坐标"]
    置信度 = 检测["置信度"]
    print(f"检测到: {类别}, 置信度: {置信度:.2f}")
```

### 屏幕图像获取

```python
# 获取整个屏幕（左上角0,0 到 右下角800,600）
屏幕图像 = 上下文.op.获取屏幕图像cv(0, 0, 800, 600)

# 获取屏幕区域（参数为：左上角x, 左上角y, 右下角x, 右下角y）
区域图像 = 上下文.op.获取屏幕图像cv(100, 100, 300, 200)
```

### 键盘操作

```python
上下文.键盘.按下("a")  # 按下a键
上下文.键盘.释放("a")  # 释放a键
上下文.键盘.点击("enter")  # 点击回车
```

### 鼠标操作

```python
上下文.鼠标.移动(x, y)  # 移动鼠标
上下文.鼠标.点击()  # 点击
上下文.鼠标.右键点击()  # 右键点击
上下文.鼠标.拖动(x1, y1, x2, y2)  # 拖动
```

### 模拟器操作

```python
# 启动/停止
上下文.雷电模拟器.启动()
上下文.雷电模拟器.关闭()

# 包操作
上下文.雷电模拟器.启动包(包名)
上下文.雷电模拟器.关闭包(包名)

# 设备信息
is_running = 上下文.雷电模拟器.检查模拟器是否运行()
```

## 任务开发模板

### 基础任务模板

```python
from 任务流程.基础任务框架 import 基础任务, 任务上下文

class 任务模板(基础任务):
    """任务说明"""

    def 执行(self) -> bool:
        """
        返回值：
        - True: 任务成功，继续下一任务
        - False: 任务失败，终止流程
        """
        try:
            上下文 = self.上下文
            上下文.置脚本状态("开始执行任务")

            # === 任务逻辑 ===
            self._执行步骤1()
            self._执行步骤2()
            # ================

            上下文.置脚本状态("任务完成")
            return True

        except Exception as e:
            self.异常处理(e)
            return False

    def _执行步骤1(self):
        """步骤1的具体实现"""
        pass

    def _执行步骤2(self):
        """步骤2的具体实现"""
        pass
```

### 带重试的任务模板

```python
class 带重试的任务(基础任务):
    """带重试机制的任务"""

    def 执行(self) -> bool:
        最大重试次数 = 3

        for 重试次数 in range(最大重试次数):
            try:
                上下文 = self.上下文
                上下文.置脚本状态(f"尝试执行任务 ({重试次数+1}/{最大重试次数})")

                # 执行任务逻辑
                if self._执行任务逻辑():
                    return True

                # 失败但未抛异常，等待后重试
                上下文.脚本延时(2000)

            except Exception as e:
                if 重试次数 == 最大重试次数 - 1:
                    # 最后一次重试仍失败
                    self.异常处理(e)
                    return False
                else:
                    # 记录错误，继续重试
                    上下文.置脚本状态(f"任务失败，准备重试: {str(e)}")
                    上下文.脚本延时(2000)

        return False

    def _执行任务逻辑(self) -> bool:
        """任务的具体逻辑"""
        pass
```

### 循环检测任务模板

```python
class 循环检测任务(基础任务):
    """循环检测直到满足条件"""

    def 执行(self) -> bool:
        try:
            上下文 = self.上下文
            最大循环次数 = 50
            循环计数 = 0

            while 循环计数 < 最大循环次数:
                上下文.置脚本状态(f"检测中 ({循环计数+1}/{最大循环次数})")

                # 获取屏幕图像
                屏幕图像 = 上下文.op.获取屏幕图像cv(0, 0, 800, 600)

                # 检测条件
                if self._检测条件(屏幕图像):
                    上下文.置脚本状态("检测成功")
                    return True

                循环计数 += 1
                上下文.脚本延时(1000)

            # 超过最大次数
            raise RuntimeError("检测超时：超过最大循环次数")

        except Exception as e:
            self.异常处理(e)
            return False

    def _检测条件(self, 图像) -> bool:
        """检测是否满足条件"""
        pass
```

## 调试技巧

### 打印日志
```python
上下文.置脚本状态(f"当前坐标: x={x}, y={y}")
上下文.置脚本状态(f"检测结果: {检测列表}")
```

### 保存图像
```python
import cv2
cv2.imwrite("debug.png", 屏幕图像)
```

### 暂停执行
```python
上下文.脚本延时(5000)  # 暂停5秒，方便观察
```

## 注意事项

1. **异常处理**：所有任务都应该在 `try-except` 中执行
2. **返回值**：明确返回 True/False 控制流程
3. **日志记录**：关键步骤记录日志，方便调试
4. **循环限制**：避免死循环，设置最大次数
5. **延时控制**：适当延时，避免操作过快
6. **线程安全**：使用上下文提供的方法，不要直接操作UI
