# 06 - 开发规范

## 环境要求

### 硬件要求

- **内存**：至少 8GB
- **显卡**：支持 GPU 加速（可选）
- **存储**：至少 5GB 可用空间

### 软件要求

1. **模拟器分辨率**：800x600
2. **模拟器DPI**：160
3. **Windows缩放**：必须100%
4. **Python版本**：3.10.9
5. **操作系统**：Windows 10/11

## 代码规范

### 命名规范

1. **中文命名**：项目使用中文命名变量、函数、类
   ```python
   # ✅ 正确
   def 执行任务():
       机器人标志 = "robot_1"

   # ❌ 错误
   def execute_task():
       robot_id = "robot_1"
   ```

2. **类名**：使用名词
   ```python
   class 基础任务:
       pass
   ```

3. **函数名**：使用动词
   ```python
   def 执行():
       pass

   def 获取机器人设置():
       pass
   ```

### 文件路径规范

1. **模板路径**：不含 `模板/` 前缀
   ```python
   # ✅ 正确
   是否匹配, _, _ = self.模板识别.执行匹配(图像, "按钮.bmp", 0.9)

   # ❌ 错误
   是否匹配, _, _ = self.模板识别.执行匹配(图像, "模板/按钮.bmp", 0.9)
   ```

2. **多模板**：使用 `|` 分隔
   ```python
   是否匹配, _, _ = self.模板识别.执行匹配(
       图像,
       "按钮1.bmp|按钮2.bmp|按钮3.bmp",
       0.9
   )
   ```

### 布尔参数规范

**命令行中**：直接写参数名，不要写 `=True`

```bash
# ✅ 正确
python 主入口.py 是否刷天鹰火炮

# ❌ 错误
python 主入口.py 是否刷天鹰火炮=True
```

### 异常处理规范

```python
class 我的任务(基础任务):
    def 执行(self) -> bool:
        try:
            # 任务逻辑
            return True
        except Exception as e:
            # 使用统一的异常处理
            self.异常处理(e)
            return False
```

**不要**：
- 捕获异常后不处理
- 吞掉异常
- 打印异常后继续执行

### 日志规范

```python
# ✅ 正确：使用上下文记录日志
上下文.置脚本状态("正在执行任务")

# ❌ 错误：直接print
print("正在执行任务")
```

### 循环限制

**必须**设置最大循环次数，避免死循环：

```python
最大循环次数 = 50
循环计数 = 0

while 循环计数 < 最大循环次数:
    # 循环逻辑
    循环计数 += 1

    if 循环计数 >= 最大循环次数:
        raise RuntimeError("超过最大循环次数")
```

## Git规范

### 提交规范

1. **提交信息**：使用中文，清晰描述改动
   ```bash
   git commit -m "添加自动捐兵功能"
   git commit -m "修复天鹰火炮检测bug"
   git commit -m "优化UI滚动体验"
   ```

2. **引用issue**：解决issue时在commit中引用
   ```bash
   git commit -m "修复配置面板滚动问题 #123"
   ```

3. **Co-Author**：与Claude协作时添加Co-Author
   ```bash
   git commit -m "添加UI自动生成功能

   Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>"
   ```

### 分支规范

- `main` - 主分支，稳定版本
- `dev` - 开发分支
- `feature/功能名` - 功能分支
- `bugfix/问题描述` - 修复分支

## 法律合规

### 已实施的措施

1. **用户协议** - 首次启动必须同意，可随时撤销
2. **免责声明** - `DISCLAIMER.md` 中英双语
3. **风险文档** - `docs/法律风险与责任分析.md` 详细说明

### 文档语言规范

**禁止使用**：
- "反检测优化"
- "无人值守挂机"
- "祝你挂机愉快"
- "绕过封号"
- "逃避检测"

**推荐使用**：
- "技术学习"
- "定时启动"
- "操作模拟"
- "自动化演示"

**例外**：
在**警告语境**中可以使用"外挂"一词，用于风险告知：
```
⚠️ 警告：使用自动化工具可能被游戏官方视为外挂行为
```

### 开发原则

1. **教育目的**：项目仅用于技术学习和演示
2. **风险告知**：充分告知用户使用风险
3. **用户责任**：明确用户需自行承担责任
4. **禁止商用**：不得用于商业用途

## 性能优化

### 图像处理

1. **降低分辨率**：仅获取必要区域
   ```python
   # ✅ 正确：直接获取目标区域（参数：左上x, 左上y, 右下x, 右下y）
   区域图像 = 上下文.op.获取屏幕图像cv(100, 100, 300, 200)

   # ❌ 错误：获取整个屏幕后裁剪
   全屏图像 = 上下文.op.获取屏幕图像cv(0, 0, 800, 600)
   区域图像 = 全屏图像[100:200, 100:300]
   ```

2. **复用检测器**：使用预初始化的检测器
   ```python
   # ✅ 正确：使用self.检测器
   结果 = self.检测器.检测(图像)

   # ❌ 错误：每次创建新检测器
   检测器 = YOLO检测器()
   结果 = 检测器.检测(图像)
   ```

### 延时控制

```python
# 适当延时，避免操作过快导致误判
上下文.点击(x, y, 500)  # 点击后延时500ms
上下文.脚本延时(1000)   # 等待1秒
```

### 内存管理

```python
# 释放大型对象
del 图像
gc.collect()
```

## 调试技巧

### 启用调试日志

```python
上下文.置脚本状态(f"调试信息: x={x}, y={y}, 结果={结果}")
```

### 保存调试图像

```python
import cv2
cv2.imwrite(f"debug_{time.time()}.png", 图像)
```

### 使用断点

```python
import pdb
pdb.set_trace()  # 设置断点
```

### 测试单个任务

```python
if __name__ == "__main__":
    # 创建测试上下文
    from 数据库.任务数据库 import 任务数据库
    数据库 = 任务数据库()
    # ... 初始化上下文

    # 测试任务
    任务 = 我的任务(上下文)
    结果 = 任务.执行()
    print(f"任务结果: {结果}")
```

## 常见问题

### 问题1：模板匹配失败

**原因**：
- 分辨率不对
- Windows缩放不是100%
- 模板图片过时

**解决**：
1. 检查模拟器分辨率：800x600, DPI 160
2. 检查Windows缩放：100%
3. 重新截取模板图片

### 问题2：OCR识别不准

**原因**：
- 图像质量差
- 文字过小
- 字体特殊

**解决**：
1. 提高图像分辨率
2. 调整OCR参数
3. 使用多种识别方法组合

### 问题3：YOLO检测不到目标

**原因**：
- 目标过小
- 置信度阈值过高
- 模型未训练该类别

**解决**：
1. 降低置信度阈值
2. 过滤小目标（宽≥20, 高≥20）
3. 重新训练模型

### 问题4：程序卡死

**原因**：
- 死循环
- 等待超时
- 线程死锁

**解决**：
1. 添加循环计数器
2. 设置超时时间
3. 检查线程同步逻辑

## 安全注意事项

1. **不要硬编码敏感信息**
   ```python
   # ❌ 错误
   密码 = "123456"

   # ✅ 正确
   密码 = os.getenv("PASSWORD")
   ```

2. **不要提交数据库文件**
   - `.gitignore` 中已排除 `任务系统.db`

3. **不要提交配置文件**
   - 用户配置文件不应提交到仓库

## 代码审查清单

提交前检查：
- [ ] 代码遵循命名规范
- [ ] 添加了适当的日志
- [ ] 异常处理完善
- [ ] 循环有最大次数限制
- [ ] 没有硬编码路径
- [ ] 删除了调试代码
- [ ] 更新了相关文档
- [ ] 测试通过
