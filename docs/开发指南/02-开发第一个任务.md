# 开发第一个任务（小白教程）

> 本教程手把手教你开发一个简单的任务，适合零基础的开发者。

## 🎯 我们要做什么？

开发一个**自动领取每日礼物**的任务！

**功能描述**：
1. 检测是否有"每日礼物"按钮
2. 如果有，点击它
3. 记录日志

## 📚 前置知识

### 你需要知道的

1. **Python基础**：变量、函数、类（不需要很深入）
2. **坐标系统**：屏幕上的点用 (x, y) 表示
3. **图像匹配**：用模板图片在屏幕上找相同的图案

### 不需要知道的

- ❌ 不需要了解GUI编程
- ❌ 不需要了解多线程
- ❌ 不需要了解图像处理算法

**这些都已经封装好了！**

## 🚀 第一步：准备模板图片

### 什么是模板图片？

模板图片就是你要在屏幕上找的按钮/图标的截图。

### 如何制作模板？

1. **启动游戏**，进入主界面
2. **截图**（Windows: Win + Shift + S）
3. **裁剪**出你要找的按钮（只保留按钮部分）
4. **保存**为 `.bmp` 格式
5. **放入** `模板/` 文件夹

**示例**：

假设我们要找"每日礼物"按钮，截图后裁剪出按钮部分：

```
模板/每日礼物按钮.bmp  ← 保存在这里
```

💡 **技巧**：
- 模板图片要清晰
- 只包含按钮本身，不要包含太多背景
- 分辨率要和游戏一致（800x600）

## 🔨 第二步：创建任务文件

### 在哪里创建？

在 `任务流程/` 目录下创建一个新文件：

```
任务流程/领取每日礼物.py
```

### 代码框架

```python
# 任务流程/领取每日礼物.py

from 任务流程.基础任务框架 import 基础任务, 任务上下文

class 领取每日礼物(基础任务):
    """领取每日礼物任务"""

    def 执行(self) -> bool:
        """
        执行任务的主方法

        返回值：
            True - 任务成功
            False - 任务失败
        """
        try:
            # 第3步的代码写在这里
            pass

        except Exception as e:
            # 出错了就调用这个
            self.异常处理(e)
            return False
```

**代码解释**：

| 代码 | 含义 |
|------|------|
| `from 任务流程.基础任务框架 import ...` | 导入任务基类 |
| `class 领取每日礼物(基础任务)` | 创建一个任务类，继承基类 |
| `def 执行(self)` | 任务的执行方法 |
| `return True` | 任务成功 |
| `return False` | 任务失败 |
| `try...except` | 错误处理 |

## 📝 第三步：编写任务逻辑

### 完整代码

```python
# 任务流程/领取每日礼物.py

from 任务流程.基础任务框架 import 基础任务, 任务上下文

class 领取每日礼物(基础任务):
    """领取每日礼物任务"""

    def 执行(self) -> bool:
        try:
            # 1. 获取上下文（包含所有工具）
            上下文 = self.上下文

            # 2. 记录日志
            上下文.置脚本状态("开始查找每日礼物按钮")

            # 3. 截取屏幕图像
            屏幕图像 = 上下文.op.获取屏幕图像cv(0, 0, 800, 600)

            # 4. 在屏幕上找"每日礼物按钮"
            是否找到, (x, y), 相似度 = self.模板识别.执行匹配(
                屏幕图像,              # 在哪里找
                "每日礼物按钮.bmp",    # 找什么
                0.8                   # 相似度阈值（0-1，越高越严格）
            )

            # 5. 判断是否找到
            if 是否找到:
                上下文.置脚本状态(f"找到按钮了！位置: ({x}, {y})")

                # 6. 点击按钮
                上下文.点击(x, y, 500)  # 点击后延时500毫秒

                # 7. 等待礼物领取动画
                上下文.脚本延时(2000)  # 等待2秒

                上下文.置脚本状态("每日礼物领取成功！")
                return True  # 任务成功

            else:
                上下文.置脚本状态("没有找到每日礼物按钮（可能已领取）")
                return True  # 没找到不算失败

        except Exception as e:
            # 出错了（比如模板文件不存在）
            self.异常处理(e)
            return False
```

### 代码逐行解释

#### 获取上下文

```python
上下文 = self.上下文
```

**什么是上下文？**
上下文就是一个工具箱，里面装着你需要的所有工具：
- 截图工具（`上下文.op`）
- 点击工具（`上下文.点击`）
- 日志工具（`上下文.置脚本状态`）
- 等等...

#### 记录日志

```python
上下文.置脚本状态("开始查找每日礼物按钮")
```

**作用**：在界面上显示当前在做什么，方便调试。

#### 截取屏幕

```python
屏幕图像 = 上下文.op.获取屏幕图像cv(0, 0, 800, 600)
```

**参数说明**：
- `0, 0` - 左上角坐标 (x1, y1)
- `800, 600` - 右下角坐标 (x2, y2)
- 这行代码截取整个游戏窗口（从左上角0,0到右下角800,600）

💡 **技巧**：如果你只想截取某个区域，可以修改参数：
```python
# 只截取右上角区域（从600,0到800,200）
屏幕图像 = 上下文.op.获取屏幕图像cv(600, 0, 800, 200)
```

#### 模板匹配

```python
是否找到, (x, y), 相似度 = self.模板识别.执行匹配(
    屏幕图像,
    "每日礼物按钮.bmp",
    0.8
)
```

**参数说明**：
- `屏幕图像` - 在哪里找
- `"每日礼物按钮.bmp"` - 找什么（模板文件名）
- `0.8` - 相似度阈值（0-1）
  - 越接近1，要求越严格
  - 一般设置0.8-0.9

**返回值说明**：
- `是否找到` - True/False
- `(x, y)` - 找到的位置坐标
- `相似度` - 匹配相似度（0-1）

#### 点击按钮

```python
上下文.点击(x, y, 500)
```

**参数说明**：
- `x, y` - 点击位置
- `500` - 点击后延时500毫秒

💡 **为什么要延时？**
给游戏反应时间，避免操作太快导致失败。

#### 延时等待

```python
上下文.脚本延时(2000)
```

**作用**：暂停2000毫秒（2秒）

💡 **注意**：
- 使用 `上下文.脚本延时` 而不是 `time.sleep`
- 因为 `脚本延时` 支持暂停/停止功能

## 🧪 第四步：测试任务

### 创建测试脚本

在项目根目录创建 `测试_领取每日礼物.py`：

```python
# 测试_领取每日礼物.py

import sys
sys.path.insert(0, ".")

from 任务流程.领取每日礼物 import 领取每日礼物
from 任务流程.基础任务框架 import 任务上下文
from 数据库.任务数据库 import 任务数据库
from 核心.op import op类
from 模块.雷电模拟器操作类 import 雷电模拟器操作类
from 核心.鼠标操作 import 鼠标控制器
from 核心.键盘操作 import 键盘控制器
import threading
import queue

# 创建测试上下文
数据库 = 任务数据库()

上下文 = 任务上下文(
    机器人标志="测试机器人",
    数据库=数据库,
    消息队列=queue.Queue(),
    继续事件=threading.Event(),
    停止事件=threading.Event(),
    op=op类(0),  # 0表示第一个模拟器
    雷电模拟器=雷电模拟器操作类(0),
    键盘=键盘控制器(),
    鼠标=鼠标控制器(),
    置脚本状态=lambda msg: print(f"[日志] {msg}")
)

上下文.继续事件.set()  # 允许执行

# 执行任务
print("=" * 50)
print("开始测试：领取每日礼物任务")
print("=" * 50)

任务 = 领取每日礼物(上下文)
结果 = 任务.执行()

print("=" * 50)
print(f"测试结果: {'成功' if 结果 else '失败'}")
print("=" * 50)
```

### 运行测试

```bash
python 测试_领取每日礼物.py
```

**预期输出**：
```
==================================================
开始测试：领取每日礼物任务
==================================================
[日志] 开始查找每日礼物按钮
[日志] 找到按钮了！位置: (700, 50)
[日志] 每日礼物领取成功！
==================================================
测试结果: 成功
==================================================
```

## 🐛 第五步：调试技巧

### 问题1：找不到按钮

**可能原因**：
1. 模板图片不清晰
2. 相似度阈值太高
3. 模板图片路径错误

**解决方法**：

```python
# 1. 降低相似度阈值
是否找到, (x, y), 相似度 = self.模板识别.执行匹配(
    屏幕图像,
    "每日礼物按钮.bmp",
    0.7  # 改为0.7试试
)

# 2. 保存截图，检查图像质量
import cv2
cv2.imwrite("debug_屏幕截图.png", 屏幕图像)
print("已保存截图到 debug_屏幕截图.png")

# 3. 打印详细信息
print(f"是否找到: {是否找到}")
print(f"相似度: {相似度}")
print(f"坐标: ({x}, {y})")
```

### 问题2：点击位置不对

**解决方法**：

```python
# 在点击前打印坐标
print(f"准备点击: ({x}, {y})")

# 暂停一下，观察
上下文.脚本延时(3000)  # 暂停3秒

# 然后再点击
上下文.点击(x, y, 500)
```

### 问题3：程序报错

**常见错误**：

1. **找不到模板文件**
   ```
   FileNotFoundError: 模板/每日礼物按钮.bmp
   ```
   → 检查文件名和路径

2. **模块导入失败**
   ```
   ModuleNotFoundError: No module named 'xxx'
   ```
   → 检查是否在项目根目录运行

3. **类型错误**
   ```
   TypeError: ...
   ```
   → 检查参数类型是否正确

## 🎉 第六步：集成到主流程

任务测试通过后，集成到机器人的主流程中。

### 编辑机器人流程

打开 `线程/自动化机器人.py`，找到 `_任务流程()` 方法，添加你的任务：

```python
def _任务流程(self):
    """任务执行流程"""

    # ... 现有任务 ...

    # 添加新任务
    from 任务流程.领取每日礼物 import 领取每日礼物
    领取每日礼物(上下文).执行()

    # ... 其他任务 ...
```

### 重新启动程序

```bash
python UI入口.py
```

现在你的任务会在机器人运行时自动执行！

## 📚 进阶学习

恭喜！你已经完成了第一个任务！

### 下一步可以学习：

1. **使用OCR识别文字** → [任务开发进阶](./03-任务开发进阶.md)
2. **使用YOLO检测对象** → [任务开发进阶](./03-任务开发进阶.md)
   - ⚠️ **注意**：项目自带的YOLO模型只能检测4种资源建筑（金矿、金库、圣水采集器、圣水瓶）
   - 如需检测其他目标，请查看 [YOLO检测器完整指南](./06-YOLO检测器完整指南.md) 训练自己的模型
3. **添加配置选项** → [添加配置选项](./04-添加配置选项.md)
4. **提交你的代码** → [提交贡献](./05-提交贡献.md)

## 💡 小技巧总结

| 技巧 | 说明 |
|------|------|
| 📝 多记日志 | `上下文.置脚本状态("...")"` 方便调试 |
| 🐌 适当延时 | 给游戏反应时间 |
| 🎯 精准模板 | 模板图片要清晰，只包含目标 |
| 🔍 保存截图 | 调试时保存图像查看 |
| ⚡ 先测试再集成 | 单独测试通过后再加入主流程 |

## ❓ 常见问题

### Q: 我不会Python怎么办？

**A**: 没关系！跟着教程照抄代码，慢慢就会了。重点理解：
- 任务类
- 执行方法
- 返回True/False

### Q: 模板匹配不准确怎么办？

**A**: 尝试：
1. 降低相似度阈值（0.7-0.8）
2. 重新截取更清晰的模板
3. 使用OCR识别（进阶教程）

### Q: 如何调试我的任务？

**A**:
1. 使用测试脚本单独运行
2. 多打印日志
3. 保存调试截图
4. 逐步执行，慢慢排查

### Q: 任务可以重复使用吗？

**A**: 可以！所有任务都可以在不同地方调用：
```python
任务 = 领取每日礼物(上下文)
任务.执行()  # 调用一次
任务.执行()  # 再调用一次
```

## 🔗 相关资源

- [项目设计思路](./00-项目设计思路.md) - 理解整体架构
- [快速开始](./01-快速开始.md) - 环境搭建
- [核心API文档](../核心文档/任务开发API.md) - 详细API说明
